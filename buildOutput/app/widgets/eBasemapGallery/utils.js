//>>built
define("dojo/_base/lang dojo/Deferred dojo/_base/array dojo/promise/all jimu/portalUtils jimu/SpatialReference/wkidUtils jimu/shared/basePortalUrlUtils esri/request".split(" "),function(e,g,h,q,k,r,t,u){function n(a){if(!a)return null;var b=a.indexOf("?");return 0===a.search(/http|\/\//)&&-1!==b?a.slice(0,b).replace(/\/*$/g,""):a}function l(a){return a?t.removeProtocol(n(a)):null}function p(a){var b=[];h.forEach(a,function(a){b.push(a.url)});b.sort();a="";for(var c=0,c=0;c<b.length;c++){var d=b[c].indexOf("?"),
f="",f=-1!==d?b[c].slice(0,d):b[c];a+=f}return a.replace(/\ /,"")}function v(a){var b=!1;if(a)for(var c=0;c<a.length;c++)if(a[c].type){b=!0;break}return b}function w(a,b){var c=null,d=new g;b.spatialReference||a.spatialReference?(c=b.spatialReference||a.spatialReference,d.resolve(c)):a.owner&&0===a.owner.indexOf("esri_")?d.resolve({wkid:"102100"}):v(b.baseMap.baseMapLayers)?d.resolve({wkid:"102100"}):b.baseMap.baseMapLayers&&b.baseMap.baseMapLayers[0]?u({url:b.baseMap.baseMapLayers[0].url,content:{f:"json"},
handleAs:"json",callbackParamName:"callback"}).then(e.hitch(this,function(a){c=a.spatialReference?a.spatialReference:null;d.resolve(c)}),e.hitch(this,function(){d.resolve(null)})):d.resolve(null);return d}function x(a){var b=new g;k.getPortalSelfInfo(a).then(e.hitch(this,function(c){var d=k.getPortal(a);c=c.basemapGalleryGroupQuery;var f=c.indexOf("esri_");if(0<=f){var f=c.slice(f,f+7),m="esri_"+dojoConfig.locale.slice(0,2);c=c.replace(f,m)}d.queryGroups({f:"json",q:c}).then(e.hitch(this,function(a){0<
a.results.length?a.results[0].queryItems({start:1,num:100,f:"json",q:k.webMapQueryStr}).then(e.hitch(this,function(a){b.resolve(a)}),e.hitch(this,function(){b.reject()})):b.reject()}),e.hitch(this,function(){b.reject()}))}),e.hitch(this,function(){b.reject()}));return b}return{_loadPortalBaseMaps:function(a,b){var c=new g,d=[];x(a).then(function(a){h.forEach(a.results,function(a){var c=new g;d.push(c);a.getItemData().then(function(d){w(a,d).then(e.hitch(this,function(f){var e=[];if(b&&f&&r.isSameSR(b.wkid,
f.wkid)){var e=h.map(d.baseMap.baseMapLayers,function(a){return a}),m=l(a.thumbnailUrl);c.resolve({layers:e,title:a.title,thumbnailUrl:m,spatialReference:f})}else c.resolve({})}))})});q(d).then(function(a){a=h.filter(a,function(a){return a&&a.title?!0:!1},this);c.resolve(a)})},function(a){c.reject(a)});return c},compareSameBasemap:function(a,b){b=b.layers;var c="",d="",c=p(a.layers),d=p(b);return c===d},compareSameBasemapByOrder:function(a,b){a=a.layers;b=b.layers;if(a.length!==b.length)return!1;
for(var c=0;c<a.length;c++)if(a[c].type||(a[c].type=null),b[c].type||(b[c].type=null),a[c].type!==b[c].type||!a[c].type&&!a[c].type&&(a[c].url||(a[c].url=null),b[c].url||(b[c].url=null),l(a[c].url)!==l(b[c].url)))return!1;return!0},isBingMap:function(a){if(!a||!a.layers)return!1;for(var b=0;b<a.layers.length;b++)if("BingMapsAerial"===a.layers[b].type||"BingMapsRoad"===a.layers[b].type||"BingMapsHybrid"===a.layers[b].type)return!0;return!1},isNoUrlLayerMap:function(a){if(!a||!a.layers)return!1;for(var b=
0;b<a.layers.length;b++)if("BingMapsAerial"===a.layers[b].type||"BingMapsRoad"===a.layers[b].type||"BingMapsHybrid"===a.layers[b].type||"OpenStreetMap"===a.layers[b].type)return!0;return!1},getToken:function(a){a=k.getPortal(a);a.updateCredential();return a.credential?"?token\x3d"+a.credential.token:""},removeUrlQuery:function(a){return n(a)},getStanderdUrl:function(a){return l(a)}}});