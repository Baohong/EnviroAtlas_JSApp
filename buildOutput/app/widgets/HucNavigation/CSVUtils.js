//>>built
define("exports dojo/_base/lang dojo/_base/array dojo/_base/html dojo/has dojo/Deferred jimu/utils esri/lang esri/tasks/QueryTask esri/tasks/query".split(" "),function(e,t,n,v,u,r,p,x,y,z){function w(b){var c=t.clone(b.attributes);(b=b.geometry)&&"point"===b.type&&("x"in c?c._x=b.x:c.x=b.x,"y"in c?c._y=b.y:c.y=b.y);return c}e.exportCSV=function(b,c,d){return e._createCSVStr(c,d).then(function(a){return e._download(b+".csv",a)})};e.exportCSVFromFeatureLayer=function(b,c,d){d=d||{};return e._getExportData(c,
{datas:d.datas,fromClient:d.fromClient,withGeometry:d.withGeometry,outFields:d.outFields,filterExpression:d.filterExpression}).then(function(a){return e._formattedData(c,a,{formatNumber:d.formatNumber,formatDate:d.formatDate,formatCodedValue:d.formatCodedValue,popupInfo:d.popupInfo}).then(function(a){return e.exportCSV(b,a.datas,a.columns)})})};e.exportCSVByAttributes=function(b,c,d,a){a=t.mixin({},a);a.datas=d;return e.exportCSVFromFeatureLayer(b,c,a)};e.exportCSVByGraphics=function(b,c,d,a){d=n.map(d,
function(a){return a.attributes});return e.exportCSVByAttributes(b,c,d,a)};e._createCSVStr=function(b,c){var d=new r,a="",e=0,g=0,f="",k="";try{n.forEach(c,function(b){a=a+f+b;f=","});for(var a=a+"\r\n",e=b.length,g=c.length,q=0;q<e;q++){for(var f="",l=0;l<g;l++)(k=b[q][c[l]])||"number"===typeof k||(k=""),k&&/[",\r\n]/g.test(k)&&(k='"'+k.replace(/(")/g,'""')+'"'),a=a+f+k,f=",";a+="\r\n"}d.resolve(a)}catch(m){console.error(m),d.resolve("")}return d};e._isIE11=function(){return 11===p.has("ie")};e._isEdge=
function(){return p.has("edge")};e._getDownloadUrl=function(b){return window.Blob&&window.URL&&window.URL.createObjectURL?(b=new Blob(["\ufeff"+b],{type:"text/csv"}),URL.createObjectURL(b)):"data:attachment/csv;charset\x3dutf-8,\ufeff"+encodeURIComponent(b)};e._download=function(b,c){var d=new r;try{if(u("ie")&&10>u("ie")){var a=window.top.open("about:blank","_blank");a.document.write("sep\x3d,\r\n"+c);a.document.close();a.document.execCommand("SaveAs",!0,b);a.close()}else if(10===u("ie")||e._isIE11()||
e._isEdge()){var h=new Blob(["\ufeff"+c],{type:"text/csv"});navigator.msSaveBlob(h,b)}else{var g=v.create("a",{href:e._getDownloadUrl(c),target:"_blank",download:b},document.body);if(u("safari")){var f=document.createEvent("MouseEvents");f.initEvent("click",!0,!0);g.dispatchEvent(f)}else g.click();v.destroy(g)}d.resolve()}catch(k){d.reject(k)}return d};e._getExportData=function(b,c){var d=new r,a=null,h=c.datas,g=c.withGeometry,a=c.outFields;a&&a.length||(a=b.fields);a=t.clone(a);if(g&&!(h&&0<h.length)){var f=
"",f=-1!==a.indexOf("x")?"_x":"x";a.push({name:f,alias:f,format:{digitSeparator:!1,places:6},show:!0,type:"esriFieldTypeDouble"});f=-1!==a.indexOf("y")?"_y":"y";a.push({name:f,alias:f,format:{digitSeparator:!1,places:6},show:!0,type:"esriFieldTypeDouble"})}h&&0<h.length?d.resolve({data:h||[],outFields:a}):c.fromClient?(h=n.map(b.graphics,function(a){return g?w(a):t.clone(a)}),d.resolve({data:h||[],outFields:a})):e._getExportDataFromServer(b,a,c).then(function(b){d.resolve({data:b||[],outFields:a})});
return d};e._getExportDataFromServer=function(b,c,d){var a=new r;if("esri.layers.FeatureLayer"!==b.declaredClass)return a.resolve([]),a;var e=new y(b.url),g=new z;g.where=d.filterExpression||b.getDefinitionExpression&&b.getDefinitionExpression()||"1\x3d1";0<c.length?(b=n.map(c,function(a){return a.name}),g.outFields=b):g.outFields=["*"];g.returnGeometry=d.withGeometry;e.execute(g,function(b){b=n.map(b.features,function(a){return w(a)});a.resolve(b)},function(b){console.error(b);a.resolve([])});return a};
e._formattedData=function(b,c,d){var a=new r,h=[],g=c.data;c=c.outFields;for(var f=0,k=g.length;f<k;f++){for(var q={},l=0;l<c.length;l++){var m=c[l];q[m.alias||m.name]=e._getExportValue(g[f][m.name],m,b.objectIdField,b.typeIdField,g[f][b.typeIdField],b.types,d)}h.push(q)}b=n.map(c,function(a){return a.alias||a.name});a.resolve({datas:h,columns:b});return a};e._getExportValue=function(b,c,d,a,e,g,f){function k(a){if(h&&x.isDefined(h.fieldInfos))for(var b=0,c=h.fieldInfos.length;b<c;b++){var d=h.fieldInfos[b];
if(d.fieldName===a)return d.format}return null}var h=f.popupInfo,l=!!c.domain&&f.formatCodedValue;f="esriFieldTypeDate"===c.type&&f.formatDate;var m=d&&c.name===d;a=a&&c.name===a;return f?p.fieldFormatter.getFormattedDate(b,k(c.name)):a?p.fieldFormatter.getTypeName(b,g):l?p.fieldFormatter.getCodedValue(c.domain,b):l||f||m||a?b:(l=null,d&&g&&0<g.length&&(d=(d=n.filter(g,function(a){return a.id===e}))&&d[0])&&d.domains&&d.domains[c.name]&&d.domains[c.name].codedValues&&(l=p.fieldFormatter.getCodedValue(d.domains[c.name],
b)),null!==l?l:b)}});